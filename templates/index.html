<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VR Session - PhysioVR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        .session-overlay {
            position: fixed; top: 0; left: 0; width: 100%; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; pointer-events: none;
        }
        .exit-btn {
            pointer-events: auto; background: rgba(255, 50, 50, 0.8); color: white;
            text-decoration: none; padding: 8px 20px; border-radius: 50px;
            font-weight: bold; font-size: 14px; backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2); transition: 0.3s;
        }
        .exit-btn:hover { background: #ff3232; transform: scale(1.05); }
        .session-info {
            color: #00d2ff; font-weight: bold; text-shadow: 0 0 10px rgba(0,0,0,0.8); font-size: 14px;
        }
        @media (min-width: 768px) {
            .exit-btn { font-size: 16px; padding: 10px 25px; }
            .session-info { font-size: 18px; }
        }
    </style>
</head>
<body>

    <div class="session-overlay">
        <div class="session-info" id="timer-display">Ready?</div>
        <a href="/" class="exit-btn">EXIT SESSION</a>
    </div>

    <button id="vrbtn" onclick="enableVR()"
        style="
        position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
        z-index:9999; background:#00d2ff; color:black; padding:14px 22px;
        border-radius:30px; border:none; font-weight:bold; font-size:16px;
        box-shadow:0 0 15px rgba(0,210,255,.6); cursor: pointer;">
        START WORKOUT
    </button>

    <a-scene vr-mode-ui="enabled: true" xr-mode-ui="enabled: true" device-orientation-permission-ui="enabled: false" renderer="antialias: true; colorManagement: true;">
        
        {% if env == 'gym' %}
                <img id="bg-media" src="/static/gym.png">
                {% set avatar_pos = "0 0 -5" %}
                {% set avatar_rotation = "0 -45 0" %}
                
                {% if model_filename == 'pushup_avatar' %}
                    {% set avatar_scale = "1.5 1.5 1.5" %}
                {% elif model_filename == 'pistol_squads' %}
                    {% set avatar_scale = "1.2 1.2 1.2" %}
                {% elif model_filename == 'meditation' %}
                    {% set avatar_scale = "2.2 2.2 2.2" %}
                {% elif model_filename == 'Surya_namaskar' %}
                    {% set avatar_scale = "2.2 2.2 2.2" %}
                {% else %} {% set avatar_scale = "2.2 2.2 2.2" %}   
                {% endif %}

                {% elif env == 'garden' %} 
                <video id="bg-media" src="/static/garden.mov" preload="metadata" muted loop playsinline webkit-playsinline crossorigin="anonymous"></video>
                {% set avatar_pos = "6 -1 -3" %}
                

                {% if model_filename == 'pushup_avatar' %}
                    {% set avatar_scale = "1 1 1" %}
                    {% set avatar_rotation = "0 0 0" %}
                {% elif model_filename == 'pistol_squads' %}
                    {% set avatar_scale = "1 1 1" %}
                    {% set avatar_rotation = "0 0 0" %}
                {% elif model_filename == 'meditation' %}
                    {% set avatar_scale = "2.5 2.5 2.5" %}
                    {% set avatar_rotation = "0 -85 0" %}
                {% elif model_filename == 'Surya_namaskar' %}
                    {% set avatar_scale = "2.5 2.5 2.5" %}
                    {% set avatar_rotation = "0 0 0" %}
                {% else %} {% set avatar_scale = " 2 2 2" %}  
                    {% set avatar_rotation = "0 0 0" %} 
                {% endif %}

            {% else %}
                <video id="bg-media" src="/static/cave.mp4" preload="metadata" muted loop playsinline webkit-playsinline crossorigin="anonymous"></video>
                {% set avatar_pos = "-7 0 -7" %}

                {% if model_filename == 'pushup_avatar' %}
                    {% set avatar_scale = "1 1 1" %}
                    {% set avatar_rotation = "0 0 0" %}
                {% elif model_filename == 'pistol_squads' %}
                    {% set avatar_scale = "0.7 0.7 0.7" %}
                    {% set avatar_rotation = "0 0 0" %}
                {% elif model_filename == 'meditation' %}
                    {% set avatar_scale = "2 2 2" %}
                    {% set avatar_rotation = "0 50 0" %}
                {% elif model_filename == 'Surya_namaskar' %}
                    {% set avatar_scale = "2 2 2" %}
                    {% set avatar_rotation = "0 0 0" %}
                {% else %} {% set avatar_scale = "2 2 2" %}   
                    {% set avatar_rotation = "0 0 0" %}
                {% endif %}
        
            {% endif %}

        <a-assets>
            <audio id="snd-good" src="/static/good.mp3"></audio>
            <a-asset-item id="avatar-model" src="/static/{{ model_filename }}.glb"></a-asset-item>
        </a-assets>

        {% if env == 'gym' %}
            <a-sky src="#bg-media" rotation="0 -90 0"></a-sky>
        {% else %}
            <a-videosphere src="#bg-media" rotation="0 180 0" material="shader: flat; side: back" stereo="eye: mono"></a-videosphere>
        {% endif %}

        <a-light type="ambient" color="#FFF" intensity="0.8"></a-light>
        <a-light type="directional" position="-1 1 0"></a-light>

        <a-entity id="rig" position="0 1.6 0"> 
            <a-entity id="head" camera="fov: 90" look-controls="magicWindowTrackingEnabled: false; touchEnabled: true">
                 <a-text id="score-text" value="Ready" position="-0.4 0.4 -1" color="white" width="1.8" font="exo2bold"></a-text>
                 <a-text id="status-text" value="Click Start" position="0.1 0.4 -1" color="#00d2ff" width="1.8" font="exo2bold"></a-text>
            </a-entity>
        </a-entity>

        <a-entity 
            gltf-model="#avatar-model" 
            position="{{ avatar_pos }}" 
            rotation="{{ avatar_rotation }}" 
            scale="{{ avatar_scale }}"
            animation-mixer="clip: *; loop: repeat; timeScale: 1">
        </a-entity>

        <a-text value="AI TRAINER" position="1 1.4 0" color="#00FFFF" align="center" width="3" font="exo2bold"></a-text>

    </a-scene>

    <script>
        var socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        
        // YOUR UPDATED LOGIC FOR TARGET/MODE
        const targetVal = urlParams.get('target') || 10;
        const exerciseType = urlParams.get('ex') || 'pushup';
        const workoutMode = urlParams.get('mode') || 'reps'; 
        
        var scoreText = document.querySelector('#score-text');
        var statusText = document.querySelector('#status-text');

        // Setup Button and Text based on Mode
        if (workoutMode === 'time') {
            document.getElementById('vrbtn').innerText = "START MEDITATION (" + targetVal + " Mins)";
            scoreText.setAttribute('value', "Target: " + targetVal + " Mins");
        } else {
            document.getElementById('vrbtn').innerText = "START WORKOUT (Target: " + targetVal + ")";
            scoreText.setAttribute('value', "Reps: 0 / " + targetVal);
        }

        async function enableVR() {
            if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
                await DeviceOrientationEvent.requestPermission();
            }
            document.querySelector("a-scene").enterVR();
        }

        let workoutStarted = false;
        document.querySelector('a-scene').addEventListener('enter-vr', async function () {
            if (!workoutStarted) {
                document.getElementById('vrbtn').style.display = 'none';
                
                const media = document.querySelector("#bg-media");
                if (media && media.tagName.toLowerCase() === 'video') {
                    media.muted = true;
                    try { await media.play(); } catch(e) {}
                }

                // Send both Target AND Mode to Python
                socket.emit('start_workout', { target: targetVal, mode: workoutMode });
                
                startTimer();
                workoutStarted = true;
            }
        });

        function startTimer() {
            var elapsed = 0;
            var timerDisplay = document.getElementById('timer-display');
            setInterval(function() {
                elapsed++;
                var minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                var seconds = (elapsed % 60).toString().padStart(2, '0');
                timerDisplay.innerText = "Session Time: " + minutes + ":" + seconds;
            }, 1000);
        }

        const feedbackMessages = {
            'cardio': ["Keep your pace!", "Breathe!", "Push it!"],
            'yoga': ["Focus on breathing.", "Clear your mind.", "Find your center."], // Changed for meditation
            'pushup': ["Keep back straight!", "Lower chest to floor!", "Great form!"],
            'squat': ["Knees out!", "Chest up!", "Drive through heels!"]
        };

        setInterval(function() {
            var msgs = feedbackMessages[exerciseType] || feedbackMessages['pushup'];
            var randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
            
            if(statusText && statusText.getAttribute('value') !== "Click Start" && statusText.getAttribute('value') !== "Session Done!") {
                 var utterance = new SpeechSynthesisUtterance(randomMsg);
                 speechSynthesis.speak(utterance);
            }
        }, 10000);

        // Python now controls exactly what the score text says (e.g. "Time Left: 2:30" or "Reps: 4/10")
        socket.on('update_vr', function(data) {
            if(data.score_text && scoreText) {
                scoreText.setAttribute('value', data.score_text);
            }
            if(data.status && statusText) {
                statusText.setAttribute('value', data.status);
            }
        });

        socket.on('play_audio', function(data) {
            var audio = document.getElementById('snd-' + data.file);
            if(audio) audio.play();
        });
    </script>
</body>
</html>